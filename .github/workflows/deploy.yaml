name: Automatic deployment to Hostinger

on:
  push:
    branches:
      - main

env:
  PROJECT_NAME: "biblios-app"
  PROJECT_DOMAIN: "green-pony-128403.hostingersite.com"
  PHP_VERSION: "8.2"
  DATABASE_URL: ${{ secrets.DATABASE_URL }}

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up PHP & Composer
        uses: shivammathur/setup-php@v2
        with:
            php-version: ${{ env.PHP_VERSION }}
            extensions: mbstring, intl, pdo, pdo_mysql, ctype, iconv, xml, zip
            tools: composer:v2.8.6
      
      - name: Set up SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.HOSTINGER_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa && chmod 600 ~/.ssh/id_rsa
          eval "$(ssh-agent -s)"
          ssh-add ~/.ssh/id_rsa

      - name: Add Hostinger to known hosts
        run: |
          ssh-keyscan -p ${{ secrets.HOSTINGER_SSH_PORT }} ${{ secrets.HOSTINGER_HOST }} >> ~/.ssh/known_hosts

      - name: Verify Composer and PHP versions
        run: |
          ssh -p ${{ secrets.HOSTINGER_SSH_PORT }} ${{ secrets.HOSTINGER_USERNAME }}@${{ secrets.HOSTINGER_HOST }} "
            php -v &&
            \$HOME/bin/composer -V
          "

      - name: Deploy Symfony public directory
        run: |
          FRONT_END_REPO="/home/${{ secrets.HOSTINGER_USERNAME }}/domains/${{ env.PROJECT_DOMAIN }}/public_html/"
          
          if [ -d "${{ env.PROJECT_NAME }}/public" ]; then
            echo "D√©ploiement du dossier public vers $FRONT_END_REPO"
            rsync -avz --delete -e "ssh -p ${{ secrets.HOSTINGER_SSH_PORT }}" \
              ${{ env.PROJECT_NAME }}/public/ \
              ${{ secrets.HOSTINGER_USERNAME }}@${{ secrets.HOSTINGER_HOST }}:$FRONT_END_REPO
          else
            echo "Erreur: Le dossier public n'existe pas dans ${{ env.PROJECT_NAME }}/"
            exit 1
          fi



      - name: Deploy Symfony backend files
        run: |
          BACK_END_REPO="/home/${{ secrets.HOSTINGER_USERNAME }}/domains/${{ env.PROJECT_DOMAIN }}/symfony-app/"
          
          echo "Cr√©ation du r√©pertoire backend: $BACK_END_REPO"
          ssh -p ${{ secrets.HOSTINGER_SSH_PORT }} \
            ${{ secrets.HOSTINGER_USERNAME }}@${{ secrets.HOSTINGER_HOST }} \
            "mkdir -p $BACK_END_REPO"
          
          echo "D√©ploiement des fichiers backend vers $BACK_END_REPO"
          cd ${{ env.PROJECT_NAME }}
          rsync -avz --delete -e "ssh -p ${{ secrets.HOSTINGER_SSH_PORT }}" \
            bin config src migrations templates translations .env composer.json composer.lock \
            ${{ secrets.HOSTINGER_USERNAME }}@${{ secrets.HOSTINGER_HOST }}:$BACK_END_REPO
  
      - name: Install Composer dependencies on server
        run: |
          ssh -p ${{ secrets.HOSTINGER_SSH_PORT }} ${{ secrets.HOSTINGER_USERNAME }}@${{ secrets.HOSTINGER_HOST }} << 'EOF'
            cd /home/${{ secrets.HOSTINGER_USERNAME }}/domains/${{ env.PROJECT_DOMAIN }}/symfony-app || exit 1
            source ~/.bashrc
            composer install --no-dev --optimize-autoloader --no-scripts
          EOF

      - name: Upload Symfony secrets to server
        run: |
          scp -P ${{ secrets.HOSTINGER_SSH_PORT }} -r biblios-app/config/secrets/prod \
            ${{ secrets.HOSTINGER_USERNAME }}@${{ secrets.HOSTINGER_HOST }}:/home/${{ secrets.HOSTINGER_USERNAME }}/domains/${{ env.PROJECT_DOMAIN }}/symfony-app/config/secrets/

      - name: Upload decrypt key to server
        run: |
          echo "${{ secrets.SYMFONY_DECRYPT_KEY }}" > prod.decrypt.private.php
          scp -P ${{ secrets.HOSTINGER_SSH_PORT }} prod.decrypt.private.php \
            ${{ secrets.HOSTINGER_USERNAME }}@${{ secrets.HOSTINGER_HOST }}:/home/${{ secrets.HOSTINGER_USERNAME }}/domains/${{ env.PROJECT_DOMAIN }}/symfony-app/config/secrets/prod/

      - name: Build Symfony app locally
        run: |
          cd ${{ env.PROJECT_NAME }}
          composer install --no-dev --optimize-autoloader --no-scripts

      - name: Inject DATABASE_URL on server
        run: |
          ssh -p ${{ secrets.HOSTINGER_SSH_PORT }} ${{ secrets.HOSTINGER_USERNAME }}@${{ secrets.HOSTINGER_HOST }} "
            echo 'DATABASE_URL=\"${{ secrets.DATABASE_URL }}\"' >> /home/${{ secrets.HOSTINGER_USERNAME }}/domains/${{ env.PROJECT_DOMAIN }}/symfony-app/.env
          "

      - name: Check remote .env file
        run: |
          ssh -p ${{ secrets.HOSTINGER_SSH_PORT }} ${{ secrets.HOSTINGER_USERNAME }}@${{ secrets.HOSTINGER_HOST }} "
            cat /home/${{ secrets.HOSTINGER_USERNAME }}/domains/${{ env.PROJECT_DOMAIN }}/symfony-app/.env
          "

      - name: Test DB connection on remote server
        run: |
          ssh -p ${{ secrets.HOSTINGER_SSH_PORT }} ${{ secrets.HOSTINGER_USERNAME }}@${{ secrets.HOSTINGER_HOST }} "
            cd /home/${{ secrets.HOSTINGER_USERNAME }}/domains/${{ env.PROJECT_DOMAIN }}/symfony-app &&
            DATABASE_URL='${{ secrets.DATABASE_URL }}' php -r '
              \$url = getenv(\"DATABASE_URL\");
              if (!\$url) {
                echo \"DATABASE_URL not set\\n\";
                exit(1);
              }
              try {
                \$params = parse_url(\$url);
                if (!\$params) throw new Exception(\"Invalid DATABASE_URL\");
                \$pdo = new PDO(\"mysql:host=\".\$params[\"host\"].\";port=\".\$params[\"port\"].\";dbname=\".ltrim(\$params[\"path\"], \"/\"), \$params[\"user\"], \$params[\"pass\"] );
                echo \"DB connection successful\\n\";
                exit(0);
              } catch (Exception \$e) {
                echo \"DB connection failed: \".\$e->getMessage().\"\\n\";
                exit(1);
              }
            '
          "
          
      - name: Run database create on Hostinger
        run: |
          ssh -p ${{ secrets.HOSTINGER_SSH_PORT }} ${{ secrets.HOSTINGER_USERNAME }}@${{ secrets.HOSTINGER_HOST }} << 'EOF'
            echo "--- AJOUT PATH ---"
            source ~/.bashrc
            echo "Contenu de ~/.bashrc :"
            cat ~/.bashrc
            echo "üìç D√©but du SSH script"
            cd /home/${{ secrets.HOSTINGER_USERNAME }}/domains/${{ env.PROJECT_DOMAIN }}/symfony-app || { echo "‚ùå Dossier non trouv√©" && exit 1; }
            echo "üìç V√©rification du path"
            echo $PATH
            echo "‚úÖ Dossier trouv√© : $(pwd)"
            echo "--- Contenu du dossier ---"
            ls -lah
            echo "--- Version de PHP ---"
            which php
            php -v || echo "‚ùå PHP ne fonctionne pas"
            echo "--- Test Symfony ---"
            php -d display_errors=1 bin/console about || echo "‚ùå Symfony console KO"
            echo "--- Clear Cache ---"
            php -d display_errors=1 bin/console cache:clear -vv || echo "‚ùå Cache clear KO"
            echo "--- Cr√©ation DB ---"
            php -d display_errors=1 bin/console doctrine:database:create --env=prod --if-not-exists -vvv || echo "‚ùå DB create KO"
            echo "‚úÖ Fin du SSH script"
          EOF
          
      - name: Run migrations and Symfony commands
        run: |
          ssh -p ${{ secrets.HOSTINGER_SSH_PORT }} ${{ secrets.HOSTINGER_USERNAME }}@${{ secrets.HOSTINGER_HOST }} "
            cd /home/${{ secrets.HOSTINGER_USERNAME }}/domains/${{ env.PROJECT_DOMAIN }}/symfony-app &&
            php bin/console doctrine:migrations:migrate --no-interaction --env=prod &&
            php bin/console assets:install ../public_html --env=prod &&
            php bin/console cache:clear --no-warmup --env=prod &&
            php bin/console cache:warmup --env=prod
          "

      - name: Set permissions
        run: |
          ssh -p ${{ secrets.HOSTINGER_SSH_PORT }} \
            ${{ secrets.HOSTINGER_USERNAME }}@${{ secrets.HOSTINGER_HOST }} "
              chmod -R 755 /home/${{ secrets.HOSTINGER_USERNAME }}/domains/${{ env.PROJECT_DOMAIN }}/public_html/ &&
              chmod -R 777 /home/${{ secrets.HOSTINGER_USERNAME }}/domains/${{ env.PROJECT_DOMAIN }}/symfony-app/var/"
